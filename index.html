<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SportLetters ‚Äî Deluxe</title>
  <meta name="description" content="Trouvez des sportifs par lettre et par sport. D√©fis, timer, classement. 100% dynamique (Supabase)." />
  <link rel="preconnect" href="https://cdn.jsdelivr.net"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { color-scheme: dark }
    .bg-app { background: radial-gradient(1200px 600px at 10% -10%, rgba(16,185,129,.15), transparent),
                          radial-gradient(1000px 500px at 110% 10%, rgba(59,130,246,.12), transparent),
                          linear-gradient(180deg, #020617 0%, #0b1220 100%); }
    .card { background: rgba(2,6,23,.65); border: 1px solid rgba(51,65,85,.5); border-radius: 18px; }
    .btn { display:inline-flex; gap:.5rem; align-items:center; padding:.6rem 1rem; border-radius:12px; font-weight:600 }
    .btn-primary { background:#34d399; color:#04131a }
    .btn-primary:hover{ filter:brightness(1.05) }
    .btn-secondary{ background:#1f2937; color:#e5e7eb }
    .pill{ padding:.25rem .7rem; border-radius:9999px; border:1px solid #334155; background:#0b1220; font-size:.85rem }
  </style>

  <!-- Motion One (animations) -->
  <script type="module">
    import { animate } from "https://cdn.jsdelivr.net/npm/@motionone/dom/+esm";
    window.__animate = animate;
  </script>

  <!-- Supabase (UMD) -->
  <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

  <!-- Cl√©s Supabase (ANON = public) -->
  <script>
    window.SUPABASE_URL = "https://ndajungkcztlspmbfnwq.supabase.co";
    window.SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5kYWp1bmdrY3p0bHNwbWJmbndxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1MzM5MzgsImV4cCI6MjA3MzEwOTkzOH0.SGOMO4sKyzeCTumHMAmFx-IHbWBmnS5bDcbjx_E4prM";
  </script>
</head>
<body class="bg-app min-h-screen text-slate-100">
  <!-- Header -->
  <header class="sticky top-0 z-20 backdrop-blur bg-slate-900/60 border-b border-slate-800">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
      <div id="logo" class="w-8 h-8 rounded-xl bg-emerald-500/20 border border-emerald-400/30 grid place-items-center">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" class="text-emerald-300"><path d="M12 3l3.5 7H22l-5.5 4.5L18 21l-6-3.5L6 21l1.5-6.5L2 10h6.5L12 3z" stroke="currentColor"/></svg>
      </div>
      <div class="text-xl md:text-2xl font-extrabold">SportLetters</div>
      <span class="pill ml-1 text-emerald-300/90 border-emerald-700/40">dynamique</span>
      <nav class="ml-auto flex items-center gap-2 text-sm">
        <a href="#play" class="pill">Jouer</a>
        <a href="#leaderboard" class="pill">Classement</a>
      </nav>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-6xl mx-auto px-4 py-8 grid lg:grid-cols-[1fr_360px] gap-6">
    <!-- Left: Game -->
    <section class="space-y-4 lg:space-y-6" id="play">
      <!-- Hero -->
      <div class="card p-6 md:p-8">
        <h1 class="text-3xl md:text-5xl font-extrabold leading-tight">
          Trouve un <span class="text-emerald-400">sportif</span> par lettre.
        </h1>
        <p class="mt-3 text-slate-300 max-w-2xl">
          Timer, score, classement. Les cat√©gories et validations viennent en direct de la base Supabase.
          Partage un d√©fi via le lien !
        </p>
        <div class="mt-5 flex flex-wrap gap-3">
          <a href="#play" class="btn btn-primary">Commencer</a>
          <a href="#sponsor" class="btn btn-secondary">Sponsor / Affiliation</a>
        </div>
      </div>

      <!-- Game card -->
      <div class="card p-4 md:p-6" id="game">
        <div class="flex flex-wrap items-center gap-3">
          <input id="pseudo" placeholder="Votre pseudo" class="w-40 bg-slate-800 border border-slate-700 rounded px-2 py-1" />
          <select id="category" class="w-44 bg-slate-800 border border-slate-700 rounded px-2 py-1"></select>
          <select id="letter" class="w-24 bg-slate-800 border border-slate-700 rounded px-2 py-1"></select>
          <div class="flex items-center gap-2">
            <span class="text-xs opacity-70">‚è±</span>
            <select id="secs" class="w-28 bg-slate-800 border border-slate-700 rounded px-2 py-1">
              <option>60</option><option selected>90</option><option>120</option><option>180</option>
            </select>
          </div>
          <div class="ml-auto flex gap-2">
            <button id="playBtn" class="btn btn-primary">D√©marrer</button>
            <button id="resetBtn" class="btn btn-secondary">R√©initialiser</button>
          </div>
        </div>

        <div class="flex items-center gap-3 mt-3">
          <div class="flex-1 h-2 bg-slate-800 rounded overflow-hidden"><div id="bar" class="h-full bg-emerald-400" style="width:0%"></div></div>
          <div class="w-16 text-right font-mono tabular-nums" id="left">90</div>
        </div>

        <div class="flex gap-2 mt-3">
          <input id="entry" placeholder="Saisissez un nom" class="flex-1 bg-slate-800 border border-slate-700 rounded px-2 py-2" />
          <button id="validate" class="btn btn-secondary">Valider</button>
        </div>

        <div class="grid md:grid-cols-2 gap-4 mt-4">
          <div>
            <h3 class="text-sm uppercase tracking-wide opacity-80 mb-2">Trouv√©s (<span id="countFound">0</span>)</h3>
            <div id="found" class="flex flex-wrap gap-2"></div>
          </div>
          <div>
            <h3 class="text-sm uppercase tracking-wide opacity-80 mb-2">Erreurs (<span id="countWrong">0</span>)</h3>
            <div id="wrong" class="flex flex-wrap gap-2"></div>
          </div>
        </div>

        <div class="flex flex-wrap items-center gap-3 pt-3 border-t border-slate-800 mt-3">
          <div class="flex items-center gap-2 text-lg font-semibold">üèÜ Score: <span id="score" class="font-mono tabular-nums text-emerald-400">0</span></div>
          <div class="opacity-70">Meilleur: <span id="best" class="font-mono tabular-nums">0</span></div>
          <div class="ml-auto">
            <button id="share" class="pill">Copier lien de d√©fi</button>
          </div>
        </div>
      </div>

      <!-- Admin (hidden: ?admin=1) -->
      <div id="admin" class="card p-4 hidden">
        <h3 class="font-semibold">Admin: Import CSV athletes</h3>
        <p class="text-sm opacity-80">Format: <code>name,category</code> ‚Äî ex√©cute en lots (1000 max / op).</p>
        <textarea id="csv" class="w-full h-40 bg-slate-900 border border-slate-800 rounded p-2 mt-2" placeholder="name,category&#10;Kylian Mbapp√©,Football"></textarea>
        <div class="mt-2 flex gap-2">
          <button id="import" class="btn btn-primary">Importer</button>
          <div id="importStatus" class="text-sm opacity-80"></div>
        </div>
      </div>
    </section>

    <!-- Right: Ads / Leaderboard -->
    <aside class="space-y-4">
      <div class="card p-4" id="sponsor">
        <h3 class="font-semibold">Espace sponsor / pub</h3>
        <p class="text-sm opacity-80 mt-1">Place AdSense / Affiliations (billetterie, maillots, streaming) / Sponsor natif.</p>
      </div>

      <div class="card p-4" id="leaderboard">
        <h3 class="font-semibold mb-2">Classement (Top 100)</h3>
        <div class="grid grid-cols-4 gap-2 text-xs opacity-70 border-b border-slate-800 pb-2">
          <div>Joueur</div><div>Pts</div><div>Mode</div><div>Date</div>
        </div>
        <div id="lbRows" class="divide-y divide-slate-800 text-sm"></div>
      </div>
    </aside>
  </main>

  <footer class="max-w-6xl mx-auto px-4 pb-10 pt-4 opacity-70 text-sm">
    ¬© <span id="year"></span> SportLetters
  </footer>

  <!-- App logic -->
  <script type="module">
    const animate = window.__animate;
    const sb = supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);

    const LETTERS = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");

    // State
    let categories = [];
    let currentCat = "";
    let letter = "A";
    let secs = 90, left = 90, timer = null, running = false;
    let found = [], wrong = [];
    let poolCache = {}; // { cat: string[] }
    let best = Number(localStorage.getItem("sl:best")||"0");

    // UI refs
    const el = (s)=>document.querySelector(s);
    const $category = el("#category");
    const $letter = el("#letter");
    const $secs = el("#secs");
    const $left = el("#left");
    const $bar = el("#bar");
    const $entry = el("#entry");
    const $found = el("#found");
    const $wrong = el("#wrong");
    const $score = el("#score");
    const $best = el("#best");
    const $countFound = el("#countFound");
    const $countWrong = el("#countWrong");
    const $pseudo = el("#pseudo");

    // Helpers
    const norm = s => s.toLowerCase().normalize("NFD").replace(/\p{Diacritic}/gu,"").replace(/[^a-z0-9\s]/g,"").trim();

    // Supabase IO
    async function loadCategories(){
      const { data, error } = await sb.from("athletes").select("category").order("category");
      if (error){ console.error(error); return []; }
      return [...new Set(data.map(r=>r.category))];
    }

    async function loadPool(cat){
      if (poolCache[cat]) return poolCache[cat];
      const { data, error } = await sb.from("athletes").select("name").eq("category", cat).limit(10000);
      if (error){ console.error(error); return []; }
      const names = data.map(r=>r.name);
      poolCache[cat] = names;
      return names;
    }

    async function saveScore(points){
      const player = ($pseudo.value || "anon").slice(0,32);
      const mode = `${currentCat}-${letter}-${secs}`;
      await sb.from("scores").insert({ player, points, mode });
      refreshLeaderboard();
    }

    async function refreshLeaderboard(){
      const { data } = await sb.from("scores").select("*").order("points",{ascending:false}).limit(100);
      const rows = (data||[]).map(r=>
        `<div class="grid grid-cols-4 gap-2 py-2">
          <div>${escapeHtml(r.player)}</div>
          <div class="font-mono">${r.points}</div>
          <div class="truncate">${escapeHtml(r.mode)}</div>
          <div class="opacity-70">${new Date(r.created_at).toLocaleString()}</div>
        </div>`).join("");
      el("#lbRows").innerHTML = rows || '<div class="py-6 opacity-60">Aucun score pour le moment.</div>';
    }

    function escapeHtml(s){ return String(s).replace(/[&<>"]\/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])) }

    // Game logic
    function renderLists(){
      $found.innerHTML = found.map(n=>`<span class="px-2 py-1 rounded-full bg-emerald-600/20 border border-emerald-700/40 text-emerald-200 text-sm">${escapeHtml(n)}</span>`).join("") || '<div class="opacity-60 text-sm">‚Äî</div>';
      $wrong.innerHTML = wrong.map(n=>`<span class="px-2 py-1 rounded-full border border-rose-700/40 text-rose-300/90 text-sm">${escapeHtml(n)}</span>`).join("") || '<div class="opacity-60 text-sm">‚Äî</div>';
      $countFound.textContent = String(found.length);
      $countWrong.textContent = String(wrong.length);
      $score.textContent = String(found.length*10 - wrong.length*2);
      if (Number($score.textContent) > best){
        best = Number($score.textContent);
        localStorage.setItem("sl:best", String(best));
      }
      $best.textContent = String(best);
      animate("#score",{ scale:[1,1.15,1] },{ duration:.35, easing:"ease-in-out" });
    }

    function setBar(){
      const pct = running ? (left/secs)*100 : 0;
      $bar.style.width = pct + "%";
    }

    function start(){
      found=[]; wrong=[]; left=secs; running=true; renderLists(); setBar();
      if (timer) clearInterval(timer);
      timer = setInterval(()=> {
        left--; $left.textContent = left; setBar();
        if (left<=0){ stop(true); }
      }, 1000);
      $entry.focus();
    }

    async function stop(auto=false){
      running=false; if (timer) clearInterval(timer);
      await saveScore(Number($score.textContent));
      if (auto) animate("#bar",{ width:["100%","0%"] },{ duration:.4 });
    }

    async function submit(){
      const v = $entry.value.trim();
      if (!v || !currentCat || !letter) return;
      $entry.value = "";
      const names = await loadPool(currentCat);
      const okLetter = norm(v).startsWith(norm(letter));
      const hit = names.find(n=> norm(n)===norm(v) );
      if (hit && okLetter){
        if (!found.map(norm).includes(norm(hit))) found.push(hit);
      } else {
        wrong.push(v);
      }
      renderLists();
    }

    // Share challenge
    function shareLink(){
      const u = new URL(location.href);
      u.searchParams.set("cat", currentCat);
      u.searchParams.set("letter", letter);
      u.searchParams.set("secs", String(secs));
      navigator.clipboard.writeText(u.toString());
    }

    // Init
    (async function init(){
      document.getElementById("year").textContent = (new Date()).getFullYear();
      // Animate logo on load
      animate("#logo",{ opacity:[0,1], y:[-8,0] },{ duration:.8 });

      // Letters
      $letter.innerHTML = LETTERS.map(L=>`<option>${L}</option>`).join("");

      // Load categories
      categories = await loadCategories();
      $category.innerHTML = categories.map(c=>`<option>${c}</option>`).join("");
      currentCat = categories[0] || "";

      // Restore best
      $best.textContent = String(best);

      // Events
      document.getElementById("playBtn").onclick = start;
      document.getElementById("resetBtn").onclick = ()=>{ running=false; clearInterval(timer); found=[]; wrong=[]; left=secs; $left.textContent=secs; renderLists(); setBar(); };
      document.getElementById("validate").onclick = submit;
      document.getElementById("share").onclick = shareLink;

      $entry.addEventListener("keydown", e=>{ if (e.key==="Enter") submit(); });
      $category.addEventListener("change", e=>{ currentCat=e.target.value; });
      $letter.addEventListener("change", e=>{ letter=e.target.value; });
      $secs.addEventListener("change", e=>{ secs=Number(e.target.value); left=secs; $left.textContent=secs; setBar(); });

      // Challenge params
      const q = new URLSearchParams(location.search);
      if (q.get("cat")) { currentCat = q.get("cat"); $category.value=currentCat; }
      if (q.get("letter")) { letter = q.get("letter"); $letter.value=letter; }
      if (q.get("secs")) { secs = Number(q.get("secs")); $secs.value=String(secs); left=secs; $left.textContent=secs; }

      // Admin import visible ?
      if (q.get("admin")==="1"){
        document.getElementById("admin").classList.remove("hidden");
        document.getElementById("import").onclick = async ()=>{
          const raw = document.getElementById("csv").value.trim();
          if (!raw) return;
          const lines = raw.split(/\r?\n/).filter(Boolean);
          const rows = [];
          for (let i=0;i<lines.length;i++){
            if (i===0 && lines[i].toLowerCase().startsWith("name,category")) continue;
            const [name,category] = lines[i].split(",").map(s=>s?.trim());
            if (name && category) rows.push({ name, category });
          }
          // Batch insert (chunk 1000)
          let done=0;
          for (let i=0;i<rows.length;i+=1000){
            const chunk = rows.slice(i,i+1000);
            const { error } = await sb.from("athletes").insert(chunk);
            if (error) { document.getElementById("importStatus").textContent = "Erreur: "+error.message; return; }
            done += chunk.length;
            document.getElementById("importStatus").textContent = `Import√©s: ${done}/${rows.length}`;
          }
          categories = await loadCategories();
          $category.innerHTML = categories.map(c=>`<option>${c}</option>`).join("");
        };
      }

      // Leaderboard initial
      refreshLeaderboard();
    })();
  </script>
</body>
</html>
